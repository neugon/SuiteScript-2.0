"use strict";define(["N/search","N/record","N/email","N/runtime","N/error"],function(e,r,t,a,i){function n(e,r){log.error("Stage: "+r+" failed",e);var i=-5,n="notify@company.com",s="Map/Reduce script "+a.getCurrentScript().id+" failed for stage: "+r,u="An error occurred with the following information:\nError code: "+e.name+"\nError msg: "+e.message;t.send({author:i,recipients:n,subject:s,body:u})}function s(e){var r=e.inputSummary,t=e.mapSummary,a=e.reduceSummary;if(r.error){var s=i.create({name:"INPUT_STAGE_FAILED",message:r.error});n(s,"getInputData")}u("map",t),u("reduce",a)}function u(e,r){var t=[];if(r.errors.iterator().each(function(e,r){var a="Failure to accept payment from customer id: "+e+". Error was: "+JSON.parse(r).message+"\n";return t.push(a),!0}),t.length>0){var a=i.create({name:"RECORD_TRANSFORM_FAILED",message:JSON.stringify(t)});n(a,e)}}function o(e){try{var t=e.seconds,i=e.usage,s=e.yields,u=r.create({type:"customrecord_summary"});u.setValue({fieldId:"name",value:"Summary for M/R script: "+a.getCurrentScript().id}),u.setValue({fieldId:"custrecord_time",value:t}),u.setValue({fieldId:"custrecord_usage",value:i}),u.setValue({fieldId:"custrecord_yields",value:s}),u.save()}catch(o){n(o,"summarize")}}function c(e){var t,a=r.load({type:r.Type.INVOICE,id:e,isDynamic:!0}),i=a.getText({fieldId:"location"});t="East Coast"===i?"Eight Percent":"West Coast"===i?"Five Percent":"United Kingdom"===i?"Nine Percent":"",a.setText({fieldId:"discountitem",text:t,ignoreFieldChange:!1}),log.debug(e+" has been updated with location-based discount."),a.save()}function d(t){return e.create({type:r.Type.INVOICE,filters:[["status",e.Operator.IS,"open"]],columns:["entity"],title:"Open Invoice Search"})}function l(e){var r=JSON.parse(e.value),t=r.id,a=r.values.entity.value;c(t),e.write(a,t)}function m(e){for(var t=e.key,a=r.transform({fromType:r.Type.CUSTOMER,fromId:t,toType:r.Type.CUSTOMER_PAYMENT,isDynamic:!0}),i=a.getLineCount("apply"),n=0;i>n;n+=1)a.selectLine({sublistId:"apply",line:n}),a.setCurrentSublistValue({sublistId:"apply",fieldId:"apply",value:!0});var s=a.save();e.write(s)}function p(e){s(e),o(e)}return{getInputData:d,map:l,reduce:m,summarize:p}});